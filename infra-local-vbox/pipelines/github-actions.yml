name: Infrastructure CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  validate:
    name: Validation de la configuration
    runs-on: ubuntu-latest

    steps:
    - name: Checkout du code
      uses: actions/checkout@v3

    - name: Installation de Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Installation d'Ansible
      run: |
        pip install ansible ansible-lint

    - name: Validation de la syntaxe Ansible
      run: |
        cd ansible
        ansible-playbook --syntax-check playbooks/site.yml

    - name: Linting Ansible
      run: |
        cd ansible
        ansible-lint playbooks/site.yml
      continue-on-error: true

    - name: Validation du Vagrantfile
      run: |
        curl -fsSL https://apt.releases.hashicorp.com/gpg | sudo apt-key add -
        sudo apt-add-repository "deb [arch=amd64] https://apt.releases.hashicorp.com $(lsb_release -cs) main"
        sudo apt-get update && sudo apt-get install vagrant
        vagrant validate

  test:
    name: Tests de sécurité
    runs-on: ubuntu-latest
    needs: validate

    steps:
    - name: Checkout du code
      uses: actions/checkout@v3

    - name: Scan de sécurité avec Trivy
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'config'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'

    - name: Upload des résultats
      uses: github/codeql-action/upload-sarif@v2
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'
