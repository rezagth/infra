# -*- mode: ruby -*-
# vi: set ft=ruby :

Vagrant.configure("2") do |config|
  
  # Synchronisation de dossiers
  config.vm.synced_folder ".", "/vagrant", disabled: true
  
  # ========================================
  # Serveur Wazuh (Manager + Indexer + Dashboard)
  # ========================================
  config.vm.define "wazuh-server" do |server|
    server.vm.box = "ubuntu/jammy64"
    server.vm.hostname = "wazuh-server"
    server.vm.network "private_network", ip: "192.168.56.10"
    
    # Configuration VirtualBox - Serveur nécessite plus de ressources
    server.vm.provider "virtualbox" do |vb|
      vb.name = "wazuh-server"
      vb.memory = "4096"  # 4GB pour Indexer + Manager + Dashboard
      vb.cpus = 2
      vb.customize ["modifyvm", :id, "--natdnshostresolver1", "on"]
    end
    
    # Message informatif
    server.vm.post_up_message = <<-MSG
    ╔══════════════════════════════════════════════════════════╗
    ║             Serveur Wazuh démarré                         ║
    ║                                                           ║
    ║  IP: 192.168.56.10                                       ║
    ║  Dashboard: https://192.168.56.10                        ║
    ║  API: https://192.168.56.10:55000                        ║
    ║                                                           ║
    ║  Exécutez le playbook Ansible pour installer Wazuh       ║
    ╚══════════════════════════════════════════════════════════╝
    MSG
  end
  
  # ========================================
  # Client Windows 11 - Machine avec agent Wazuh
  # ========================================
  config.vm.define "windows-client" do |client|
    # Image Windows 11 Enterprise
    client.vm.box = "gusztavvargadr/windows-11"
    client.vm.hostname = "windows-client"
    client.vm.network "private_network", ip: "192.168.56.20"
    
    # Configuration WinRM pour Ansible
    client.vm.communicator = "winrm"
    client.winrm.username = "vagrant"
    client.winrm.password = "vagrant"
    client.winrm.transport = :plaintext
    client.winrm.basic_auth_only = true
    
    client.vm.provider "virtualbox" do |vb|
      vb.name = "wazuh-windows11-client"
      vb.memory = "4096"  # 4GB pour Windows 11 (minimum recommandé)
      vb.cpus = 2
      vb.gui = true  # Interface graphique activée pour Windows 11
      vb.customize ["modifyvm", :id, "--vram", "128"]
      vb.customize ["modifyvm", :id, "--clipboard", "bidirectional"]
      vb.customize ["modifyvm", :id, "--accelerate3d", "on"]
    end
    
    # Message informatif
    client.vm.post_up_message = <<-MSG
    ╔══════════════════════════════════════════════════════════╗
    ║         Client Windows 11 démarré                         ║
    ║                                                           ║
    ║  IP: 192.168.56.20                                       ║
    ║  OS: Windows 11 Pro (23H2)                               ║
    ║  User: vagrant / Password: vagrant                       ║
    ║                                                           ║
    ║  L'agent Wazuh sera installé via Ansible                 ║
    ║  GUI activée - Utilisez 'vagrant rdp windows-client'     ║
    ╚══════════════════════════════════════════════════════════╝
    MSG
  end
  
  # ========================================
  # Provisioning Ansible (manuel)
  # ========================================
  # Décommenter pour provisionner automatiquement avec Ansible
  # config.vm.provision "ansible" do |ansible|
  #   ansible.playbook = "ansible/playbooks/site.yml"
  #   ansible.inventory_path = "ansible/inventories/hosts.ini"
  #   ansible.limit = "all"
  # end
end
