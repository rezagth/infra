---
# ========================================
# Playbook Principal - Infrastructure Wazuh
# ========================================

# Phase 1: Configuration de base pour tous les hÃ´tes
- name: Configuration de base - Tous les hÃ´tes
  hosts: all
  become: true
  gather_facts: true

  pre_tasks:
    - name: Mise Ã  jour du cache APT
      apt:
        update_cache: yes
        cache_valid_time: 3600
      when: ansible_os_family == "Debian"

    - name: VÃ©rification de la connectivitÃ©
      ping:

    - name: Afficher les informations de l'hÃ´te
      debug:
        msg:
          - "Hostname: {{ ansible_hostname }}"
          - "IP: {{ ansible_default_ipv4.address }}"
          - "OS: {{ ansible_distribution }} {{ ansible_distribution_version }}"

  roles:
    - hardening

# Phase 2: DÃ©ploiement du serveur Wazuh
- name: Installation du serveur Wazuh
  hosts: wazuh_servers
  become: true
  gather_facts: true

  roles:
    - wazuh-server

  post_tasks:
    - name: Attendre que le serveur soit complÃ¨tement opÃ©rationnel
      wait_for:
        port: "{{ item }}"
        delay: 5
        timeout: 300
      loop:
        - 1514   # Agent connection
        - 1515   # Agent enrollment
        - 55000  # API
        - 9200   # Indexer
        - 443    # Dashboard

    - name: Afficher le message de succÃ¨s
      debug:
        msg:
          - "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          - "â•‘    Serveur Wazuh installÃ© et opÃ©rationnel !              â•‘"
          - "â•‘                                                           â•‘"
          - "â•‘    Dashboard: https://{{ ansible_default_ipv4.address }} â•‘"
          - "â•‘    PrÃªt Ã  recevoir les agents...                         â•‘"
          - "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

# Phase 3: DÃ©ploiement des agents Wazuh
- name: Installation des agents Wazuh sur les clients
  hosts: wazuh_agents
  become: true
  gather_facts: true
  serial: 2  # DÃ©ployer 2 agents en parallÃ¨le

  roles:
    - wazuh-agent

  post_tasks:
    - name: VÃ©rifier le statut de l'agent
      shell: /var/ossec/bin/wazuh-control status
      register: agent_status
      changed_when: false

    - name: Afficher le statut
      debug:
        msg: "Agent {{ ansible_hostname }}: {{ agent_status.stdout_lines }}"

# Phase 4: VÃ©rification finale
- name: VÃ©rification du dÃ©ploiement complet
  hosts: wazuh_servers
  become: true
  gather_facts: false

  tasks:
    - name: Lister les agents connectÃ©s
      shell: /var/ossec/bin/agent_control -l
      register: connected_agents
      changed_when: false

    - name: Afficher les agents connectÃ©s
      debug:
        msg: "{{ connected_agents.stdout_lines }}"

    - name: RÃ©sumÃ© final
      debug:
        msg:
          - ""
          - "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          - "â•‘        DÃ©ploiement Wazuh TerminÃ© avec SuccÃ¨s !           â•‘"
          - "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - ""
          - "ğŸ“Š Dashboard: https://{{ ansible_default_ipv4.address }}"
          - "ğŸ” Credentials: /root/wazuh-install-credentials.txt"
          - "ğŸ“ RÃ©sumÃ©: /root/wazuh-installation-summary.txt"
          - ""
          - "Agents connectÃ©s:"
          - "{{ connected_agents.stdout }}"
          - ""

