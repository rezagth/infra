---
# ========================================
# Playbook Principal - Infrastructure Wazuh avec Windows
# ========================================

# Phase 1: Configuration serveur Wazuh (Linux)
- name: Configuration de base - Serveur Wazuh
  hosts: wazuh_servers
  become: true
  gather_facts: true

  pre_tasks:
    - name: Mise Ã  jour du cache APT
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: VÃ©rification de la connectivitÃ©
      ping:

    - name: Afficher les informations de l'hÃ´te
      debug:
        msg:
          - "Hostname: {{ ansible_hostname }}"
          - "IP: {{ ansible_default_ipv4.address }}"
          - "OS: {{ ansible_distribution }} {{ ansible_distribution_version }}"

  roles:
    - hardening

# Phase 2: DÃ©ploiement du serveur Wazuh
- name: Installation du serveur Wazuh
  hosts: wazuh_servers
  become: true
  gather_facts: true

  roles:
    - wazuh-server

  post_tasks:
    - name: Attendre que le serveur soit complÃ¨tement opÃ©rationnel
      wait_for:
        port: "{{ item }}"
        delay: 5
        timeout: 300
      loop:
        - 1514   # Agent connection
        - 1515   # Agent enrollment
        - 55000  # API
        - 9200   # Indexer
        - 443    # Dashboard

    - name: Afficher le message de succÃ¨s
      debug:
        msg:
          - "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          - "â•‘    Serveur Wazuh installÃ© et opÃ©rationnel !              â•‘"
          - "â•‘                                                           â•‘"
          - "â•‘    Dashboard: https://{{ ansible_default_ipv4.address }} â•‘"
          - "â•‘    PrÃªt Ã  recevoir les agents...                         â•‘"
          - "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

# Phase 3: DÃ©ploiement des agents Wazuh Windows
- name: Installation des agents Wazuh sur Windows
  hosts: wazuh_agents_windows
  gather_facts: true

  roles:
    - wazuh-agent-windows

  post_tasks:
    - name: VÃ©rifier le statut du service
      win_service:
        name: WazuhSvc
      register: agent_service

    - name: Afficher le statut
      debug:
        msg: "Agent {{ ansible_hostname }}: Service {{ agent_service.state }}"

# Phase 4: VÃ©rification finale
- name: VÃ©rification du dÃ©ploiement complet
  hosts: wazuh_servers
  become: true
  gather_facts: false

  tasks:
    - name: Attendre 30 secondes que les agents se connectent
      pause:
        seconds: 30

    - name: Lister les agents connectÃ©s
      shell: /var/ossec/bin/agent_control -l
      register: connected_agents
      changed_when: false

    - name: Afficher les agents connectÃ©s
      debug:
        msg: "{{ connected_agents.stdout_lines }}"

    - name: RÃ©sumÃ© final
      debug:
        msg:
          - ""
          - "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          - "â•‘      DÃ©ploiement Wazuh Windows TerminÃ© !                 â•‘"
          - "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - ""
          - "ğŸ“Š Dashboard: https://{{ ansible_default_ipv4.address }}"
          - "ğŸ” Credentials: /root/wazuh-install-credentials.txt"
          - ""
          - "Agents:"
          - "{{ connected_agents.stdout }}"
          - ""
