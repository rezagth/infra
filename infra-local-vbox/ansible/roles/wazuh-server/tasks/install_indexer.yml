---
# Installation de Wazuh avec le script d'installation all-in-one

- name: Vérifier si Wazuh est déjà installé
  stat:
    path: /var/ossec/bin/wazuh-control
  register: wazuh_already_installed

- name: Télécharger le script d'installation Wazuh all-in-one
  shell: |
    wget https://packages.wazuh.com/4.7/wazuh-install.sh -O /tmp/wazuh-install.sh
    chmod +x /tmp/wazuh-install.sh
  args:
    creates: /tmp/wazuh-install.sh
  when: not wazuh_already_installed.stat.exists

- name: Vérifier que le script a bien été téléchargé et est valide
  shell: |
    head -1 /tmp/wazuh-install.sh | grep -q "^#!/bin"
  register: script_valid
  changed_when: false
  failed_when: false
  when: not wazuh_already_installed.stat.exists

- name: Afficher erreur si le script n'est pas valide
  fail:
    msg: "Le script téléchargé n'est pas un script shell valide. Vérifiez la connectivité internet."
  when: 
    - not wazuh_already_installed.stat.exists
    - script_valid.rc != 0

- name: Exécuter l'installation all-in-one de Wazuh
  shell: |
    bash /tmp/wazuh-install.sh -a -i 2>&1 | tee /tmp/wazuh-install.log
  args:
    chdir: /tmp
  register: wazuh_install
  async: 1800
  poll: 10
  when: not wazuh_already_installed.stat.exists and (script_valid.rc is not defined or script_valid.rc == 0)

- name: Attendre que tous les services démarrent
  wait_for:
    port: "{{ item }}"
    delay: 10
    timeout: 300
  loop:
    - 9200  # Indexer
    - 55000 # API
    - 1514  # Manager
    - 443   # Dashboard
  when: not wazuh_already_installed.stat.exists

- name: Sauvegarder les credentials d'installation
  copy:
    content: "{{ wazuh_install.stdout }}"
    dest: /root/wazuh-install-credentials.txt
    mode: '0600'
  when: 
    - wazuh_install.stdout is defined
    - not wazuh_already_installed.stat.exists

- name: Extraire le mot de passe admin
  shell: |
    if [ -f /root/wazuh-install-credentials.txt ]; then
      grep -oP 'password: \K.*' /root/wazuh-install-credentials.txt | head -1
    else
      echo "admin"
    fi
  register: extracted_password
  changed_when: false
  failed_when: false

- name: Définir le mot de passe récupéré
  set_fact:
    wazuh_dashboard_password: "{{ extracted_password.stdout | default('admin') }}"

- name: Afficher les informations d'accès
  debug:
    msg:
      - "Installation Wazuh terminée!"
      - "Dashboard: https://{{ ansible_default_ipv4.address }}"
      - "Utilisateur: admin"
      - "Mot de passe: {{ wazuh_dashboard_password }}"
      - "Les credentials complets sont dans /root/wazuh-install-credentials.txt"
